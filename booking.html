<!DOCTYPE html>
<html lang="ar" dir="rtl" id="main-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø±Ø³Ù…ÙŠ - HASTANE</title>
    <style>
        :root { 
            --primary: #1b4332; 
            --secondary: #2d6a4f; 
            --accent: #d8f3dc; 
            --bg: #f8f9fa; 
            --white: #ffffff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--bg); 
            color: #333; 
            transition: 0.3s;
        }

        header { 
            background: var(--white); 
            padding: 15px 8%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 15px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 1.8rem; font-weight: 800; color: var(--primary); text-decoration: none; }
        .nav-links { display: flex; align-items: center; gap: 10px; }
        .nav-links a { text-decoration: none; color: var(--primary); font-weight: 600; padding: 8px 15px; border-radius: 8px; transition: 0.3s; }
        .nav-links a:hover { background: var(--accent); }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ© */
        .lang-switcher { display: flex; gap: 5px; margin: 0 10px; }
        .lang-btn { cursor: pointer; border: 1px solid #ddd; padding: 5px 8px; border-radius: 5px; font-size: 0.75rem; background: #fff; font-weight: bold; }
        .lang-btn:hover { background: var(--accent); }

        .main-container { max-width: 600px; margin: 50px auto; padding: 0 20px; }
        .booking-card { 
            background: var(--white); 
            padding: 40px; 
            border-radius: 25px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.08); 
            border: 1px solid #eee;
        }

        h2 { color: var(--primary); text-align: center; margin-bottom: 30px; font-weight: 800; }
        label { display: block; margin: 15px 5px 5px; font-weight: 600; color: var(--primary); }
        input, select, button { 
            width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 12px; 
            border: 1px solid #ddd; box-sizing: border-box; font-size: 1rem; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--secondary); outline: none; box-shadow: 0 0 8px rgba(27, 67, 50, 0.1); }

        .office-badge {
            background: var(--accent); color: var(--primary); padding: 10px;
            border-radius: 10px; font-size: 0.9rem; font-weight: bold;
            margin-bottom: 20px; display: none; text-align: center;
        }

        .time-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .time-slot { 
            padding: 12px; background: #fdfdfd; border: 1px solid #eee; border-radius: 10px; 
            cursor: pointer; text-align: center; font-weight: bold; transition: 0.2s;
        }
        .time-slot:hover:not(.busy) { border-color: var(--secondary); background: var(--accent); }
        .time-slot.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .time-slot.busy { background: #f1f1f1; color: #ccc; cursor: not-allowed; text-decoration: line-through; }

        .btn-confirm { 
            background: var(--primary); color: white; border: none; font-weight: bold; 
            margin-top: 30px; cursor: pointer; font-size: 1.1rem; height: 55px;
        }
        .btn-confirm:hover { background: var(--secondary); transform: translateY(-2px); }
        .hidden { display: none; }
    </style>
</head>
<body id="body-tag">

<header>
    <a href="index.html" class="logo">HASTANE</a>
    <nav class="nav-links">
        <div class="lang-switcher">
            <button class="lang-btn" onclick="setLanguage('ar')">AR</button>
            <button class="lang-btn" onclick="setLanguage('tr')">TR</button>
            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
        </div>
        <a href="index.html" id="nav-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="my-bookings.html" id="nav-bookings">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</a>
    </nav>
</header>

<div class="main-container">
    <div class="booking-card">
        <h2 id="form-title">ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ</h2>
        
        <label id="lbl-personal">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
        <input type="text" id="pName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø±ÙŠØ¶">
        <input type="number" id="pID" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ (T.C. No)">
        
        <label id="lbl-dept">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠ</label>
        <select id="dept" onchange="loadDocs()">
            <option value="" id="opt-dept-default">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
            <option value="Ø§Ù„Ø¹ÙŠÙˆÙ†" id="opt-eye"> Ø§Ù„Ø¹ÙŠÙˆÙ† </option>
            <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„" id="opt-child"> Ø§Ù„Ø£Ø·ÙØ§Ù„</option>
            <option value="Ø§Ù„Ø¹ÙŠÙˆÙ†" id="opt-eye"> Ø§Ù†Ù ÙˆØ§Ø°Ù† Ùˆ Ø­Ù†Ø¬Ø±Ù‡ </option>
            <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„" id="opt-child"> Ù†Ø³Ø§Ø¡ Ùˆ ÙˆÙ„Ø§Ø¯Ù‡ </option>
            <option value="Ø§Ù„Ø¹ÙŠÙˆÙ†" id="opt-eye"> Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ </option>
            <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„" id="opt-child"> Ø¨Ø§Ø·Ù†ÙŠØ© </option>
            <option value="Ø§Ù„Ø¹ÙŠÙˆÙ†" id="opt-eye"> Ù…Ø® ÙˆØ§Ø¹ØµØ§Ø¨ </option>
            <option value="Ø§Ù„Ø£Ø·ÙØ§Ù„" id="opt-child"> Ø¹Ø¸Ø§Ù… </option>
        </select>

        <label class="doc-label hidden" id="lbl-doctor">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­</label>
        <select id="docList" class="hidden" onchange="loadAvailableTimes()"></select>
        
        <div id="officeInfo" class="office-badge"></div>

        <div id="timeSection" class="hidden">
            <label id="lbl-time">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</label>
            <div class="time-grid" id="timeGrid"></div>
            <input type="hidden" id="selectedTime">
        </div>

        <button class="btn-confirm" id="bookBtn" onclick="processBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBD2Ge6v0TStampv_l_bRGnzTDVPKvCW20",
        authDomain: "hastane-b2c48.firebaseapp.com",
        projectId: "hastane-b2c48",
        storageBucket: "hastane-b2c48.firebasestorage.app",
        messagingSenderId: "788913029956",
        appId: "1:788913029956:web:84c2f36a5569c85bfd8d11"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const translations = {
        ar: {
            title: "Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø±Ø³Ù…ÙŠ - HASTANE",
            home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
            bookings: "Ø­Ø¬ÙˆØ²Ø§ØªÙŠ",
            formTitle: "ØªØ£ÙƒÙŠØ¯ Ù…ÙˆØ¹Ø¯ Ø·Ø¨ÙŠ",
            personal: "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©",
            pName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø±ÙŠØ¶",
            pID: "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ (T.C. No)",
            dept: "Ø§Ù„Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠ",
            deptDefault: "-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --",
            eye: "Ø§Ù„Ø¹ÙŠÙˆÙ† ",
            child: "Ø§Ù„Ø£Ø·ÙØ§Ù„ ",
            doctor: "Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…ØªØ§Ø­",
            docDefault: "-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ --",
            time: "Ø§Ø®ØªØ± Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©",
            confirm: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
            officePrefix: "ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©: ",
            success: "âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ Ø¨Ù†Ø¬Ø§Ø­!",
            error: "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©",
            dir: "rtl"
        },
        tr: {
            title: "Resmi Randevu Al - HASTANE",
            home: "Ana Sayfa",
            bookings: "RandevularÄ±m",
            formTitle: "TÄ±bbi Randevu OnayÄ±",
            personal: "KiÅŸisel Bilgiler",
            pName: "HastanÄ±n Tam AdÄ±",
            pID: "T.C. Kimlik No",
            dept: "TÄ±bbi BÃ¶lÃ¼m",
            deptDefault: "-- BÃ¶lÃ¼m SeÃ§iniz --",
            eye: "GÃ¶z ",
            child: "Ã‡ocuk ",
            doctor: "Uygun Doktor",
            docDefault: "-- Doktor SeÃ§iniz --",
            time: "Uygun Saati SeÃ§iniz",
            confirm: "Randevuyu Onayla",
            officePrefix: "ğŸ“ Klinik Konumu: ",
            success: "âœ… Randevunuz baÅŸarÄ±yla onaylandÄ±!",
            error: "LÃ¼tfen tÃ¼m bilgileri doldurun ve saat seÃ§in",
            dir: "ltr"
        },
        en: {
            title: "Official Appointment Booking - HASTANE",
            home: "Home",
            bookings: "My Bookings",
            formTitle: "Medical Appointment Confirmation",
            personal: "Personal Information",
            pName: "Patient's Full Name",
            pID: "National ID (T.C. No)",
            dept: "Medical Department",
            deptDefault: "-- Choose Department --",
            eye: "Ophthalmology ",
            child: "Pediatrics ",
            doctor: "Available Doctor",
            docDefault: "-- Choose Doctor --",
            time: "Choose Suitable Time",
            confirm: "Confirm Final Booking",
            officePrefix: "ğŸ“ Clinic Location: ",
            success: "âœ… Your appointment has been confirmed successfully!",
            error: "Please complete all data and select a time",
            dir: "ltr"
        }
    };

    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        const html = document.getElementById('main-html');
        const t = translations[lang];
        
        html.lang = lang;
        html.dir = t.dir;
        
        document.getElementById('page-title').innerText = t.title;
        document.getElementById('nav-home').innerText = t.home;
        document.getElementById('nav-bookings').innerText = t.bookings;
        document.getElementById('form-title').innerText = t.formTitle;
        document.getElementById('lbl-personal').innerText = t.personal;
        document.getElementById('pName').placeholder = t.pName;
        document.getElementById('pID').placeholder = t.pID;
        document.getElementById('lbl-dept').innerText = t.dept;
        document.getElementById('opt-dept-default').innerText = t.deptDefault;
        document.getElementById('opt-eye').innerText = t.eye;
        document.getElementById('opt-child').innerText = t.child;
        document.getElementById('lbl-doctor').innerText = t.doctor;
        document.getElementById('lbl-time').innerText = t.time;
        document.getElementById('bookBtn').innerText = t.confirm;
    }

    const doctorsData = {
        "Ø§Ù„Ø¹ÙŠÙˆÙ†": [
            { name: "Ø¯. Ø£Ø­Ù…Ø¯", office: "Ø§Ù„Ø·Ø§Ø¨Ù‚ 1 - Ù…ÙƒØªØ¨ 101" },
            { name: "Ø¯. Ø³Ø§Ø±Ø©", office: "Ø§Ù„Ø·Ø§Ø¨Ù‚ 1 - Ù…ÙƒØªØ¨ 102" }
        ],
        "Ø§Ù„Ø£Ø·ÙØ§Ù„": [
            { name: "Ø¯. Ù…Ø­Ù…Ø¯", office: "Ø§Ù„Ø·Ø§Ø¨Ù‚ 2 - Ù…ÙƒØªØ¨ 205" }
        ]
    };

    const hours = ["08:30", "09:30", "10:30", "11:30", "13:30", "14:30"];

    function loadDocs() {
        const d = document.getElementById('dept').value;
        const list = document.getElementById('docList');
        const labels = document.querySelectorAll('.doc-label');
        const lang = localStorage.getItem('lang') || 'ar';
        
        if(!d) {
            list.classList.add('hidden');
            labels.forEach(l => l.classList.add('hidden'));
            return;
        }

        list.innerHTML = `<option value="">${translations[lang].docDefault}</option>`;
        doctorsData[d].forEach(doc => {
            list.innerHTML += `<option value="${doc.name}" data-office="${doc.office}">${doc.name}</option>`;
        });
        list.classList.remove('hidden');
        labels.forEach(l => l.classList.remove('hidden'));
    }

    async function loadAvailableTimes() {
        const doctor = document.getElementById('docList').value;
        const officeDiv = document.getElementById('officeInfo');
        const timeSection = document.getElementById('timeSection');
        const grid = document.getElementById('timeGrid');
        const lang = localStorage.getItem('lang') || 'ar';
        
        if(!doctor) return;

        const selectedOption = document.getElementById('docList').selectedOptions[0];
        officeDiv.innerText = translations[lang].officePrefix + selectedOption.getAttribute('data-office');
        officeDiv.style.display = 'block';
        timeSection.classList.remove('hidden');

        const snapshot = await db.collection("bookings").where("doctor", "==", doctor).get();
        const busyTimes = snapshot.docs.map(doc => doc.data().time);

        grid.innerHTML = "";
        hours.forEach(h => {
            const isBusy = busyTimes.includes(h);
            const div = document.createElement('div');
            div.className = `time-slot ${isBusy ? 'busy' : ''}`;
            div.innerText = h;
            if(!isBusy) div.onclick = () => {
                document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                div.classList.add('selected');
                document.getElementById('selectedTime').value = h;
            };
            grid.appendChild(div);
        });
    }

    async function processBooking() {
        const name = document.getElementById('pName').value;
        const id = document.getElementById('pID').value;
        const doctor = document.getElementById('docList').value;
        const time = document.getElementById('selectedTime').value;
        const lang = localStorage.getItem('lang') || 'ar';

        if(!name || !id || !doctor || !time) return alert(translations[lang].error);

        try {
            await db.collection("bookings").add({
                patient: name,
                nationalID: id,
                doctor: doctor,
                department: document.getElementById('dept').value,
                time: time,
                office: document.getElementById('officeInfo').innerText,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert(translations[lang].success);
            location.href = 'my-bookings.html';
        } catch (e) { alert("Error connecting to server"); }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    const savedLang = localStorage.getItem('lang') || 'ar';
    setLanguage(savedLang);
</script>

</body>
</html>
